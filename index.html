<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Snake 300 Lines</title>
  <style>
    /* --- –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      display: flex;
      background: #111;
      color: #eee;
      font-family: "Segoe UI", sans-serif;
      user-select: none;
      overflow: hidden;
      align-items: center;
      justify-content: center;
    }
    canvas {
      background: #222;
      border: 4px solid #444;
      image-rendering: pixelated;
    }
    .overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      font-size: 24px;
      text-align: center;
    }
    .overlay.hidden { display: none; }
    .overlay .line { margin: 8px 0; }
  </style>
</head>
<body>
  <canvas id="game" width="400" height="400"></canvas>
  <div id="overlay" class="overlay">
    <div id="titleScreen">
      <div class="line">üêç –ó–º–µ–π–∫–∞</div>
      <div class="line">–ù–∞–∂–º–∏—Ç–µ ENTER, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
      <div class="line small">‚Üë‚Üì‚Üê‚Üí –∏–ª–∏ WASD</div>
    </div>
    <div id="pauseScreen" class="hidden">
      <div class="line">‚è∏ –ü–∞—É–∑–∞</div>
      <div class="line">–ù–∞–∂–º–∏—Ç–µ P, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å</div>
    </div>
    <div id="gameOverScreen" class="hidden">
      <div class="line" id="gameOverText">–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞</div>
      <div class="line" id="scoreText">–°—á—ë—Ç: 0</div>
      <div class="line">–ù–∞–∂–º–∏—Ç–µ ENTER, —á—Ç–æ–±—ã –∏–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</div>
    </div>
  </div>

  <script>
  // ==== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====
  const canvas = document.getElementById('game');
  const ctx    = canvas.getContext('2d');
  const overlay= document.getElementById('overlay');
  const titleS = document.getElementById('titleScreen');
  const pauseS = document.getElementById('pauseScreen');
  const overS  = document.getElementById('gameOverScreen');
  const scoreT = document.getElementById('scoreText');
  const gameOverT = document.getElementById('gameOverText');

  // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ—Ç–∫–∏
  const TILE = 20;
  const COLS = canvas.width / TILE;
  const ROWS = canvas.height / TILE;

  // –ò–≥—Ä–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  const STATE = { TITLE:0, PLAY:1, PAUSE:2, OVER:3 };
  let state = STATE.TITLE;

  // –ó–º–µ–π–∫–∞
  let snake, dir, nextDir, food, score, speed, highScore;

  // ==== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====
  function init() {
    snake = [{ x: Math.floor(COLS/2), y: Math.floor(ROWS/2) }];
    dir = { x:0, y:0 };
    nextDir = dir;
    placeFood();
    score = 0;
    speed = 8; // –∫–∞–¥—Ä–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É
    highScore = parseInt(localStorage.getItem('snakeHigh')) || 0;
    showScreen(STATE.TITLE);
  }

  // ==== –§–£–ù–ö–¶–ò–ò –≠–ö–†–ê–ù–û–í ====
  function showScreen(s) {
    state = s;
    titleS.classList.toggle('hidden', s !== STATE.TITLE);
    pauseS.classList.toggle('hidden', s !== STATE.PAUSE);
    overS.classList.toggle('hidden', s !== STATE.OVER);
    overlay.classList.toggle('hidden', s === STATE.PLAY);
  }

  // ==== –†–ê–ó–ú–ï–°–¢–ò–¢–¨ –ï–î–£ ====
  function placeFood() {
    let ok = false;
    while (!ok) {
      food = { x: Math.floor(Math.random()*COLS), y: Math.floor(Math.random()*ROWS) };
      ok = !snake.some(p=>p.x===food.x && p.y===food.y);
    }
  }

  // ==== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ì–†–´ ====
  function update() {
    // –ò–∑–º–µ–Ω—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    dir = nextDir;
    // –ù–æ–≤–∞—è –≥–æ–ª–æ–≤–∞
    let head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };

    // –û–±—ë—Ä—Ç–∫–∞ –ø–æ –∫—Ä–∞—è–º
    if (head.x < 0) head.x = COLS - 1;
    if (head.x >= COLS) head.x = 0;
    if (head.y < 0) head.y = ROWS - 1;
    if (head.y >= ROWS) head.y = 0;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å —Å–æ–±–æ–π (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º index 0)
    for (let i = 1; i < snake.length; i++) {
      if (snake[i].x === head.x && snake[i].y === head.y) {
        gameOver();
        return;
      }
    }

    // –í—Å—Ç–∞–≤–ª—è–µ–º –≥–æ–ª–æ–≤—É
    snake.unshift(head);

    // –ï—Å–ª–∏ —Å—ä–µ–ª–∏ –µ–¥—É
    if (head.x === food.x && head.y === food.y) {
      score++;
      if (score % 5 === 0) speed += 1; // —É—Å–∫–æ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 –æ—á–∫–æ–≤
      placeFood();
    } else {
      snake.pop();
    }
  }

  // ==== –û–¢–†–ò–°–û–í–ö–ê ====
  function draw() {
    // –§–æ–Ω
    ctx.fillStyle = '#222';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // –ï–¥–∞
    ctx.fillStyle = '#f55';
    ctx.fillRect(food.x*TILE+2, food.y*TILE+2, TILE-4, TILE-4);

    // –ó–º–µ–π–∫–∞
    ctx.fillStyle = '#5f5';
    snake.forEach((p,i)=>{
      let inset = (i===0?0:4);
      ctx.fillRect(p.x*TILE+inset, p.y*TILE+inset, TILE-2*inset, TILE-2*inset);
    });

    // –°—á—ë—Ç
    ctx.fillStyle = '#eee';
    ctx.font = '16px sans-serif';
    ctx.fillText('Score: '+score, 10, 20);
    ctx.fillText('High: '+highScore, canvas.width-100, 20);
  }

  // ==== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ü–ê–£–ó–´ ====
  function togglePause() {
    if (state===STATE.PLAY) showScreen(STATE.PAUSE);
    else if (state===STATE.PAUSE) showScreen(STATE.PLAY);
  }

  // ==== GAME OVER ====
  function gameOver() {
    showScreen(STATE.OVER);
    gameOverT.textContent = 'Game Over';
    scoreT.textContent = '–°—á—ë—Ç: '+score;
    if (score > highScore) {
      highScore = score;
      localStorage.setItem('snakeHigh', highScore);
      scoreT.textContent += ' (New High!)';
    }
  }

  // ==== –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ ====
  let lastTime = 0;
  function loop(timestamp) {
    if (state === STATE.PLAY) {
      if (timestamp - lastTime > 1000/speed) {
        update();
        draw();
        lastTime = timestamp;
      }
    }
    requestAnimationFrame(loop);
  }

  // ==== –£–ü–†–ê–í–õ–ï–ù–ò–ï ====
  document.addEventListener('keydown', e=>{
    if (state === STATE.TITLE && e.code === 'Enter') {
      showScreen(STATE.PLAY);
    }
    else if (state === STATE.OVER && e.code === 'Enter') {
      init();
    }
    else if (state === STATE.PLAY || state === STATE.PAUSE) {
      switch(e.code) {
        case 'KeyW': case 'ArrowUp':
          if (dir.y === 0) nextDir = { x:0, y:-1 }; break;
        case 'KeyS': case 'ArrowDown':
          if (dir.y === 0) nextDir = { x:0, y:1 }; break;
        case 'KeyA': case 'ArrowLeft':
          if (dir.x === 0) nextDir = { x:-1, y:0 }; break;
        case 'KeyD': case 'ArrowRight':
          if (dir.x === 0) nextDir = { x:1, y:0 }; break;
        case 'KeyP':
          togglePause(); break;
      }
      if (state===STATE.PAUSE && e.code==='KeyP') showScreen(STATE.PLAY);
    }
  });

  // ==== –°–ï–ù–°–û–†–ù–û–ï –£–ü–†–ê–í–õ–ï–ù–ò–ï (–ú–û–ë–ò–õ–ö–ê) ====
  let touchStart = null;
  canvas.addEventListener('touchstart', e=>{
    let t = e.touches[0];
    touchStart = { x:t.clientX, y:t.clientY };
  });
  canvas.addEventListener('touchmove', e=>{
    if (!touchStart) return;
    let t = e.touches[0];
    let dx = t.clientX - touchStart.x;
    let dy = t.clientY - touchStart.y;
    if (Math.abs(dx)>Math.abs(dy)) {
      if (dx>20 && dir.x===0) nextDir = { x:1, y:0 };
      if (dx<-20 && dir.x===0) nextDir = { x:-1, y:0 };
    } else {
      if (dy>20 && dir.y===0) nextDir = { x:0, y:1 };
      if (dy<-20 && dir.y===0) nextDir = { x:0, y:-1 };
    }
    touchStart = null;
  });

  // ==== –ó–ê–ü–£–°–ö ====
  init();
  requestAnimationFrame(loop);
  </script>
</body>
</html>
